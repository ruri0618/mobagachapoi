function drawGacha(times, untilSR = false, targetMember = null) {
    let results = [];
    let count = 0;
    let srHit = false;
    let oshiResultIndex = -1;

    do {
        const member = members[Math.floor(Math.random() * members.length)];
        const rarity = getRandomRarity();
        let item = "";
        let rarityTag = rarity;

        if (rarity === "N") {
            item = Math.random() < 0.5 ? "缶バッジ" : "ステッカー";
            rarityTag = item;
        } else if (rarity === "R") item = "キーホルダー";
        else if (rarity === "SR") item = "BIGアクリルスタンド";

        let displayText = rarity === "SR" ? `<span class='rainbow-text'>${rarity}：${member} - ${item}</span>` : `${rarity}：${member} - ${item}`;

        results.push({ rarity: rarityTag, member: member, item: item, display: displayText });

        if (untilSR && rarity === "SR" && (!targetMember || member === targetMember)) {
            srHit = true;
            if (targetMember) {
                oshiResultIndex = results.length - 1;
            }
            break;
        }

        count++;
    } while (count < times || untilSR);

    results.sort((a, b) => {
        const rarityOrder = { "SR": 0, "R": 1, "缶バッジ": 2, "ステッカー": 3 };
        if (rarityOrder[a.rarity] !== rarityOrder[b.rarity]) {
            return rarityOrder[a.rarity] - rarityOrder[b.rarity];
        }
        if (a.rarity === "缶バッジ" || a.rarity === "ステッカー") {
            return a.rarity.localeCompare(b.rarity);
        }
        return members.indexOf(a.member) - members.indexOf(b.member);
    });

    // 推しSRが出た場合は一番上に移動してフォント大きめにする
    if (oshiResultIndex !== -1) {
        const oshiResult = results.splice(oshiResultIndex, 1)[0];
        oshiResult.display = `<span style="font-size:24px; font-weight:bold; color:#FF69B4;">SR：${oshiResult.member} - BIGアクリルスタンド✨</span>`;
        results.unshift(oshiResult);
    }

    let displayText = results.map(r => r.display).join("<br>");
    if (untilSR && srHit) {
        const totalCost = count * 500;
        displayText = `🎉✨🎊 ${count}回でSRが出ました！（合計 ${totalCost.toLocaleString()}円）🎊✨🎉<br><br>` + displayText;
    }

    document.getElementById("result").innerHTML = displayText;
}
